# Introducción a R y visualización de datos

---  

#### Paquetes para este capítulo {-}

```{r paquetes-01, echo=TRUE, message=FALSE, warning=FALSE}

if (!require('cowplot')) install.packages('cowplot'); library('cowplot')
if (!require('esquisse')) install.packages('esquisse'); library('esquisse') 
if (!require('gapminder')) install.packages('gapminder'); library('gapminder')
if (!require('gganimate')) install.packages('gganimate'); library('gganimate')
if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')
if (!require('ggthemes')) install.packages('ggthemes'); library('ggthemes')
if (!require('ggridges')) install.packages('ggridges'); library('ggridges')
if (!require('hrbrthemes')) install.packages('hrbrthemes'); library('hrbrthemes')
if (!require('plotly')) install.packages('plotly'); library('plotly')
if (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')
# if (!require('gganimate')) devtools::install_github('thomasp85/gganimate'); library('gganimate')

```  

---  

## Introducción: porque la visualización de datos es importante


*"These 13 datasets (the Datasaurus, plus 12 others) each have the same summary statistics (x/y mean, x/y standard deviation, and Pearson's correlation) to two decimal places, while being drastically different in appearance."* (Matejka, J., & Fitzmaurice, G., 2017)  


![SOURCE: https://www.autodeskresearch.com/publications/samestats](`r here::here("data", "images", "DinoSequentialSmaller.gif")`)



### Porque la visualización de datos es importante - ejemplo del mundo real

Este ejemplo viene de un experimento que realizamos junto con [Carlos Santamaría](https://scholar.google.es/citations?user=fUHQA3gAAAAJ&hl=es) hace algún tiempo. Presentamos una tarea sobre cálculo de probabilidades en un contexto real. Nuestros participantes estaban entrando a un examen para convertirse en trabajadores del estado. La historia real tiene algunos matices, pero simplificando, digamos que la materia para el examen eran unos 80 temas. Las personas generalmente no podían estudiar con profundidad todos los temas (o sabían que esa no era la estrategia óptima), así que se concentraban en un subconjunto de esos temas (e.g. 30 de 80). En el examen, se seleccionaban al azar 5 de estos temas, y las personas tenían que elegir uno de ellos para desarrollar.  


Abajo se puede ver como cambia la probabilidad de que uno de los temas estudiados aparezca dentro de los 5 seleccionados al azar. Con 30 temas estudiados (de los 80 totales), la probabilidad de que uno de ellos salga en la prueba es del 91%. Si estudiáramos 47, subiríamos a una probabilidad del 99%.    

```{r opositores-plot, echo=FALSE, fig.height=6, fig.width=8}

hipergeometric_formula <- function(temas_totales = 80,
                 temas_estudiados = 30,
                 temas_seleccionados = 5,
                 temas_estudiados_salen = 1:5) {

  temas_NO_estudiados = temas_totales - temas_estudiados # Temas NO estudiados

  if(temas_estudiados > temas_totales) {
    NA
  } else {
    sum(
      ((factorial(temas_estudiados) / (factorial(temas_estudiados_salen) * (factorial(temas_estudiados - temas_estudiados_salen)))) *
         (factorial(temas_NO_estudiados) / ((factorial(temas_seleccionados - temas_estudiados_salen)) * (factorial(temas_NO_estudiados - (temas_seleccionados - temas_estudiados_salen))))))
      /
      (factorial(temas_estudiados + temas_NO_estudiados) / (factorial(temas_seleccionados) * factorial(temas_estudiados + temas_NO_estudiados-temas_seleccionados))),
      na.rm = TRUE)
  }

}

temas_totales = 80
data_plot = 1:temas_totales %>% map_dfr(~ hipergeometric_formula(temas_totales = temas_totales, temas_estudiados = .x) %>% as_tibble() %>% mutate(N = .x))


plotly::ggplotly(
  ggplot(data_plot, aes(N, value)) +
    geom_line() +
    geom_vline(xintercept = 30, linetype = "dashed") +
    geom_hline(yintercept = 1, linetype = "dashed") +
    scale_y_continuous(breaks = seq(0, 1, .05), labels = scales::percent(x = seq(0, 1, .05), accuracy = 1)) +
    labs(title = "Probabilidad de que uno de los temas estudiados aparezca",
         x = "Temas estudiados",
         y = "Probabilidad"))

  
```


En el experimento le preguntamos a las personas por la probabilidad de que les aparezca alguno de los temas que han estudiado en la prueba. Comparamos las siguientes dos preguntas:  

+ ¿Cuál es la probabilidad de que **salga uno** de los temas que has estudiado?  
+ ¿Cuál es la probabilidad de que **no salga ninguno** de los temas que has estudiado?  

Miramos el error promedio en función de la pregunta (cuanto se han alejado de la probabilidad correcta), y vemos que nuestra manipulación ha tenido un efecto considerable:  

```{r visualizacion-importante-01, message=FALSE, warning=FALSE, cache=FALSE}
if (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')

# Leemos datos
DF = read_csv(
  here::here("data", "files", "01-visualizacion-importante.csv")) %>% 
  mutate(Question = as.factor(
    case_when(Question_p_of == 1 ~ "p (salga uno)",
              Question_p_of == 0 ~ "p (no salga ninguno)")))

# Promedio por condicion
DF %>% 
  group_by(Question) %>% 
  summarise(Error_promedio = mean(Error),
            SD = sd(Error, na.rm = TRUE),
            N = n())

```

Hay una diferencia notable entre condiciones. Pasamos de un error promedio del -30.7% a tan solo 4%, simplemente cambiando la pregunta. Hagamos un sencillo análisis de regresión para ver si la diferencia es significativa, y cuanta varianza explica nuestro modelo.  

```{r visualizacion-importante-01b, message=FALSE, warning=FALSE, cache=TRUE}

# Modelo de regresion
modelo_regresion = lm(Error ~ Question, DF)

# Resultados
summary(modelo_regresion)

# Histograma de los residuos
hist(modelo_regresion$residuals)

# Supuesto de normalidad de residuales
shapiro.test(modelo_regresion$residuals)

```

Todo es hermoso. Tenemos un efecto claramente significativo de la pregunta (y con un R2-ajustado de .258, no está nada mal), y además, nuestro modelo no incumple el supuesto de normalidad de residuos (por los pelos!). Preparamos un plot con promedios y barras con error standard para nuestro paper:  

```{r visualizacion-importante-01c, message=FALSE, warning=FALSE, cache=TRUE}

# Plot para publicación
plot_inicial = ggplot(DF, aes(Question, Error, fill = Question)) +
  stat_summary(
    fun.y = mean,
    geom = "point",
    size = 4,
    color = "darkgrey") +
  stat_summary(geom = "errorbar", fun.data = mean_se, position = "dodge", color = "black", width = .2) +
  scale_y_continuous(limits = c(-50, 50), breaks = seq(-50, 50, 10)) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "none")

plot_inicial

```

Estamos listos para escribir nuestro paper.  

Solo por curiosidad, veamos boxplots de los dos grupos. Mmmm... hay algo extraño:  

```{r visualizacion-importante-02, message=FALSE, warning=FALSE, cache=TRUE}
  
# Boxplots por condición
ggplot(DF, aes(Question, Error, color = Question, group = Question)) +
  geom_boxplot(alpha = .5) +
  theme_minimal() +
  scale_y_continuous(limits = c(-50, 50), breaks = seq(-50, 50, 10)) +
  labs(x = "What is the probability of x?")

```

Volvemos a extraer descriptivos... pero esta vez incluimos la mediana.  

```{r visualizacion-importante-03, message=FALSE, warning=FALSE}

# Promedio y mediana por condicion
DF %>% 
  group_by(Question) %>% 
  summarise(Error_promedio = mean(Error),
            Error_mediana = median(Error),
            SD = sd(Error, na.rm = TRUE),
            N = n())

```

Que esta pasando? Veamos las respuestas de todos los participantes, junto con la distribución de los datos, más la media y mediana por condición.  

```{r visualizacion-importante-04, message=FALSE, warning=FALSE, cache=TRUE}

plot_final = ggplot(DF, aes(Question, Error, color = Question, group = Question)) +
  geom_jitter(size = 2) +
  geom_violin(alpha = .2) +
  stat_summary(
    fun.y = median,
    geom = "point",
    size = 3,
    color = "black",
    shape = 0) +
  stat_summary(
    fun.y = mean,
    geom = "point",
    size = 3,
    color = "darkgrey",
    shape = 1) +
  theme_minimal() +
  scale_y_continuous(limits = c(-50, 50), breaks = seq(-50, 50, 10)) +
  labs(x = "What is the probability of x?")

plot_final

```


**TLDR**: La manera en la visualizamos la información determina las conclusiones a las que llegamos.   

```{r visualizacion-importante-05, message=FALSE, warning=FALSE, fig.width=12, cache=TRUE}

# Visualizamos el grafico inicial y el final, uno al lado del otro
cowplot::plot_grid(plot_inicial, plot_final)

```

#### Moraleja: es importante mostrar los datos individuales y/o la distribución de los datos {-}

![SOURCE: https://www.autodeskresearch.com/publications/samestats](`r here::here("data", "images", "BoxViolinSmaller.gif")`)



---  

## Por qué R? 

R es [uno de los programas para data science mas populares](http://r4stats.com/articles/popularity/), especialmente usado en la academia. El numero de paquetes que ofrecen funcionalidades de todo tipo no ha dejado de crecer. En 2019 el numero de paquetes en [R-cran](https://cran.r-project.org/web/packages/index.html) ha superado los 14,000, y el ritmo de crecimiento nos acerca a la singularidad... ;)  

![SOURCE: https://gist.github.com/daroczig/3cf06d6db4be2bbe3368](`r here::here("data", "images", "number-of-submitted-packages-to-CRAN.png")`)

<!-- (https://gist.githubusercontent.com/daroczig/3cf06d6db4be2bbe3368/raw/b66b0531fb1b86d3e04a003b2e105ad4f147900e/number-of-submitted-packages-to-CRAN.png)   -->

---  

Además de lo anterior, R es un programa de código abierto (esencial para poder hacer buena ciencia), con una [comunidad de usuarios](https://community.rstudio.com/) muy acogedora.   

Sus funciones de visualización son muy potentes (ver la [r-graph-gallery](https://www.r-graph-gallery.com/) para algunos ejemplos), siendo usadas como herramienta principal en algunos medios como la [BBC](https://medium.com/bbc-visual-and-data-journalism/how-the-bbc-visual-and-data-journalism-team-works-with-graphics-in-r-ed0b35693535).  

---   

Con R puedes recoger datos interactivamente con [shiny](https://shiny.rstudio.com/), preparar datos (o extraerlos de paginas web con [rvest](https://github.com/tidyverse/rvest) o [RSelenium](https://github.com/ropensci/RSelenium)), visualizar datos estáticos con [ggplot](https://ggplot2.tidyverse.org/), animarlos con [gganimate](https://github.com/thomasp85/gganimate), visualizarlos con interactivamente con [plotly](https://github.com/ropensci/plotly/) o [shiny](https://shiny.rstudio.com/). Puedes también analizar los datos con todas las técnicas imaginables, desde anovas con [afex](https://github.com/singmann/afex) a modelos mixtos con [lmer](https://github.com/lme4/lme4) y/o [afex](https://github.com/singmann/afex), pasando por meta-análisis con [metafor](http://www.metafor-project.org/doku.php), SEM, Path analysis, mediación, con [lavaan](http://lavaan.ugent.be/tutorial/sem.html), análisis Bayesianos con [brms](https://github.com/paul-buerkner/brms) o [bayesfactor](http://bayesfactor.blogspot.com/), y un larguísimo etc. Puedes llevar tus visualizaciones y análisis a reportes automáticos en múltiples formatos (pdf, html, docx) con [Rmarkdown](https://rmarkdown.rstudio.com/), crear libros como este con [bookdown](https://bookdown.org/), páginas web con [blogdown](https://bookdown.org/yihui/blogdown/), e incluso papers completamente reproducibles (preparación y análisis de datos) en formato APA con [papaja](https://github.com/crsh/papaja).  

---  


### Bienvenida al tidyverse

El [tidyverse](https://www.tidyverse.org/) es un conjunto de paquetes que nos permitirán hacer de manera (habitualmente) intuitiva muchas tareas de preparación y visualización de datos.    



#### Tidyverse vs Base R

Muchas de las funciones que existen en el Tidyverse tienen un [equivalente en base-R](https://tavareshugo.github.io/data_carpentry_extras/base-r_tidyverse_equivalents/base-r_tidyverse_equivalents.html) (la instalación por defecto de R). El Tidyverse tiene ventajas y desventajas. La ventaja fundamental es que el código resulta (habitualmente) más fácil de leer, los nombres de las funciones son mas intuitivos, y las maneras de hacer las cosas tienen a ser consistentes. La desventaja fundamental es que [incrementamos el numero de dependencias](http://www.tinyverse.org/) (paquetes) de nuestro código.  


Veamos un ejemplo extraído de [aqui](https://tavareshugo.github.io/data_carpentry_extras/base-r_tidyverse_equivalents/base-r_tidyverse_equivalents.html). La misma operación con base-R o con tidyverse:    

*Filter rows with conditions evaluated within groups: iris flowers with maximum “Petal.Width” for each “Species”*  

##### Tidyverse
```{r tidyverse-vs-base-R-02}
  iris %>% 
    group_by(Species) %>% 
    filter(Petal.Width == max(Petal.Width))

```


##### Base-R
```{r tidyverse-vs-base-R-01}
  # First operate in the data.frame by group (split-apply)
  widest_petals <- by(iris, 
                      INDICES = iris$Species, 
                      FUN = function(x){
                        x[x$Petal.Width == max(x$Petal.Width), ] 
                      })
  
  # Then combine the results into a data.frame
  do.call(rbind, widest_petals)
```


### Antes de empezar

Programar (tras la fase de euforia inicial) es muy difícil. Todos necesitamos ayuda. Contar con una comunidad robusta con la que compartir, preguntar, contribuir, ayuda muchísimo.

![SOURCE: http://www.keywordbasket.com/ZWZlY3RvIGR1bm5pbmcta3J1Z2Vy/](`r here::here("data", "images", "dunning-kruger.jpg")`)  


Hay algunos recursos que resultan muy útiles:

* [Comunidad de usuarios de Rstudio](https://community.rstudio.com/)  

* [Twiter!](https://twitter.com/home). Por ejemplo:  
    + #TidyTuesday (@thomas_mock)  
    + @dataandme  
    + @rivaquiroga  
    + @RLadiesSantiago  
    

* Webs como [R bloggers](https://www.r-bloggers.com/)  


Y otros que son más que **imprescindibles**. Nadie sabe como los antiguos podían programar antes de la llegada de Stackoverflow:  

* [Google](https://www.google.com/): text size ggplot  

* [**Stack overflow**](https://stackoverflow.com/questions/tagged/r)!!!  


### R para visualización de datos

[ggplot2](https://ggplot2.tidyverse.org/) es el paquete por excelencia para visualización de datos. Su potencia va asociada a un nivel de complejidad considerable, hasta el punto que hay [Cheat sheets oficiales](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf), [Cheat sheets buscables](https://www.computerworld.com/article/2935394/my-ggplot2-cheat-sheet-search-by-task.html), y decenas de miles de preguntas en [Stack Overflow](https://stackoverflow.com/questions/tagged/ggplot2).  


#### Primeros pasos - con training wheels

Para empezar a usar ggplot sin tener que preocuparnos de su complejidad, podemos usar la función `esquisse:::esquisser()` del paquete [esquisse](https://github.com/dreamRs/esquisse). Esta nos permite usar la potencia de ggplot para explorar una base de datos de manera muy sencilla.   

![SOURCE: https://www.williamrchase.com/slides/intro_r_anthropology_2018#93](`r here::here("data", "images", "esquisse.gif")`)  

<!-- (https://www.williamrchase.com/slides/slide_img/esquisse.gif)   -->  

---  


La manera fácil (1, 2, 3), usando [esquisse](https://github.com/dreamRs/esquisse):  

```{r visualizacion_0, message=FALSE, warning=FALSE, eval=FALSE}

# 1) Asegurate que hemos instalado el paquete esquisse
  if (!require('esquisse')) install.packages('esquisse'); library('esquisse')

# 2) Carga el dataframe que desees. En este caso, "iris"
  data(iris)

# 3) Lanza el wizard esquisser
  esquisse:::esquisser()

```

#### Aprendamos con Garrick 

[Garrick Aden-Buie](https://www.garrickadenbuie.com/) (@grrrck) ha creado una excelente [introducción a ggplot2 y la gramática de gráficos](https://pkg.garrickadenbuie.com/gentle-ggplot2/#28). Vamos a usarla para familiarizarnos con algunas de las funcionalidades de ggplot.  
<!-- https://github.com/gadenbuie/gentle-ggplot2  -->


**Antes** de LANZAR LA PRESENTACION [introducción a ggplot2 y la gramática de gráficos](https://pkg.garrickadenbuie.com/gentle-ggplot2/#28), asegúrate que tienes instalados los paquetes `tidyverse` y `gapminder`, y crea el DF `pop_simple` usando el código de abajo.  

```{r garrick, message=FALSE, warning=FALSE}

if (!require('tidyverse')) install.packages('tidyverse'); library('tidyverse')
if (!require('gapminder')) install.packages('gapminder'); library('gapminder')  

tidy_pop <- gapminder %>% 
  filter(country %in% c("Canada", "China", "United States"), 
         year >= 1997) %>% 
  select(country, year, pop) %>% 
  mutate(pop = pop / 10^6)

```


## Visualización de datos con ggplot2 


### Primeros pasos

En esta sección vamos a ver algunos de los componentes que usaremos cuando visualicemos datos. Los ingredientes esenciales son:  

---  

* **Aesthetic mappings** (aes): Variables, colores, rellenos, formas, ...
* **Geoms** (geom_): puntos, lineas, boxplots, ...
* **Facets** (facet_): facet_wrap() y facet_grid()
* **Transformaciones estadísticas**: stat_summary, ..prop.., ...

---  

![SOURCE: https://skillgaze.com/2017/10/31/understanding-different-visualization-layers-of-ggplot/](`r here::here("data", "images", "visualization-layers-of-ggplot.png")`)  


---  

Muchos de los ejemplos que usamos en esta sección vienen de [R for data science](https://r4ds.had.co.nz/data-visualisation.html):  



### Aesthetic mappings

En **aes()** vamos a indicar las variables que queremos en los ejes x e y, el color de los puntos o lineas, el relleno de las barras, la forma de los puntos, el tipo de linea, la agrupación de los datos, etc.  

---  

* **x**: x = gdpPercap
* **y**: y = lifeExp
* **color**: color = continent; color = "red"; color = "#FAA627"
* **fill**: fill = continent; fill = "red"; fill = "#FAA627"
* **alpha**: alpha = continent; alpha = 0.2
* **size**: size = continent; size = 5
* **shape**:  shape = continent; shape = 0 [ver codigo de las distintas formas](https://r4ds.had.co.nz/data-visualisation.html#fig:shapes)
* **linetype**: linetype = continent; linetype = "dashed"
* **group**: group = continent

---  


```{r aes, message=FALSE, warning=FALSE, cache=TRUE}
  
  # x = gdpPercap, y = lifeExp
  ggplot(data = gapminder, 
         mapping = aes(x = gdpPercap, y = lifeExp)) + 
    geom_point()
  
  # x = lifeExp, y = gdpPercap
  ggplot(data = gapminder, 
         mapping = aes(x = lifeExp, y = gdpPercap)) + 
    geom_point()

```


#### Color, alpha, size

* Para elegir paletas de colores: [colorbrewer](http://colorbrewer2.org)  

* [Codigo HEX de colores](https://www.rapidtables.com/web/color/RGB_Color.html#color-picker)  


```{r color, message=FALSE, warning=FALSE, cache=TRUE}

  # Grafico inicial
  ggplot(gapminder, aes(gdpPercap, lifeExp)) + 
    geom_point()
  
  # Color "rojo" para los puntos
  ggplot(gapminder, aes(gdpPercap, lifeExp)) + 
    geom_point(color = "red")
  
  # Color en funcion de la variable 'continent'
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) + 
    geom_point()
  
  # Color en funcion de la variable 'continent' + size
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent, size = 2)) + 
    geom_point()
  
  # Color en funcion de la variable 'continent' + size + alpha
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent, size = 2, alpha = .1)) + 
    geom_point()
  
```

Imagina que queremos asignar colores manualmente. 

```{r color-01, message=FALSE, warning=FALSE, eval=FALSE}

  ggplot(gapminder, aes(gdpPercap, lifeExp)) + 
    geom_point(color = c("red", "grey", "green", "purple", "black")) 
  # Error: Aesthetics must be either length 1 or the same as the data (1704): colour

```

Tenemos que indicar que el color depende de 'class', y después usar scale_color_manual()  

```{r color-01b, message=FALSE, warning=FALSE, cache=TRUE}

  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) + 
    geom_point() +
    scale_color_manual(values = c("red", "grey", "green", "purple", "black"))

```


#### Shape

Códigos para las distintas formas:  

![SOURCE: https://r4ds.had.co.nz/data-visualisation.html#aesthetic-mappings](`r here::here("data", "images", "shapes-1.png")`)

<!-- (https://d33wubrfki0l68.cloudfront.net/2705b59d57362a103f0dad04b0ccfdeff9a101d2/3dc1b/visualize_files/figure-html/shapes-1.png) -->  

```{r shape, message=TRUE, warning=TRUE, cache=TRUE}

  ggplot(gapminder, aes(gdpPercap, lifeExp, shape = continent)) + 
    geom_point() 

```



#### Linetype

Códigos para los distintos estilos de linea:  

![SOURCE: http://sape.inf.usi.ch/quick-reference/ggplot2/linetype](`r here::here("data", "images", "ggplot2-linetype-identity.png")`)  

<!-- (http://sape.inf.usi.ch/sites/default/files/ggplot2-linetype-identity.png) -->  

```{r linetype, message=FALSE, warning=FALSE, cache=TRUE}

  ggplot(gapminder, aes(year, lifeExp, linetype = continent, color = continent)) + 
    stat_summary(fun.y = mean, geom = "line") 

```


### Geoms

Una de las cosas más difíciles (inicialmente) cuando nos enfrentamos a unos datos nuevos es elegir el método más efectivo para visualizar los datos. Hay varios recursos interesantes sobre [cómo elegir una gráfica](https://github.com/widged/data-for-good/wiki/Visualisation-::-Choosing-a-chart). En esta sección veremos distintos tipos de geoms_().    

#### geom_point y geom_jitter


```{r geoms-points-smooth, message=FALSE, warning=FALSE, cache=TRUE}

# Points
  ggplot(mpg, aes(displ, hwy)) + 
    geom_point()


# Jitter Points
  ggplot(mpg, aes(displ, hwy)) + 
    geom_jitter()

```

#### geom_smooth

```{r geom-smooth, message=FALSE, warning=FALSE, cache=TRUE}
  
  # Linea de tendencia (default loess)
  ggplot(gapminder, aes(gdpPercap, lifeExp)) + 
    geom_point() +
    geom_smooth()

  # Usamos lm
  ggplot(gapminder, aes(gdpPercap, lifeExp)) + 
    geom_point() +
    geom_smooth(method = "lm")

  # Un smooth por cada clase
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) + 
    geom_point() +
    geom_smooth()

  # Coloreamos puntos pero mantenemos un solo smooth
  ggplot(gapminder, aes(gdpPercap, lifeExp)) + 
    geom_point(aes(color = continent)) +
    geom_smooth()

    
```




---  

Hagamos una pausa para hacer algunos [ejercicios usando diferentes geoms, colores...](#ejercicios-geoms-colores)  

---  


#### geom_boxplot y geom_violin

```{r geoms-boxplot-violin, message=FALSE, warning=FALSE, cache=TRUE}

  # Boxplot base
  ggplot(gapminder, aes(continent, lifeExp)) + 
    geom_boxplot(alpha = .2)

  # Boxplot con fill
  ggplot(gapminder, aes(continent, lifeExp, fill = continent)) + 
    geom_boxplot(alpha = .2)

  # Violins  
  ggplot(gapminder, aes(continent, lifeExp, fill = continent)) + 
    geom_violin(alpha = .2)
  
  # Combinamos ambos  
  ggplot(gapminder, aes(continent, lifeExp)) + 
    geom_boxplot(alpha = .2) +
    geom_violin(alpha = .2, aes(fill = continent))

```


#### geom_histogram

```{r geom-histogram, message=FALSE, warning=FALSE, cache=TRUE}

  # Histogram - variable continua
  ggplot(gapminder, aes(lifeExp)) + 
    geom_histogram()

  # Histogram - variable categorica
  ggplot(gapminder, aes(continent)) +
    geom_histogram(stat = "count") 

  # Histogram - variable categorica, con fill y alpha
  ggplot(gapminder, aes(continent, fill = continent, alpha = .2)) +
    geom_histogram(stat = "count") 

    
```


#### geom_dotplot

```{r geom-dotplot, message=FALSE, warning=FALSE, cache=TRUE}
  
  # Dotplot
  ggplot(mpg, aes(manufacturer)) +
    geom_dotplot() +
    coord_flip()

```


#### geom_density

```{r geom-density, message=FALSE, warning=FALSE, cache=TRUE}
  
  # Density
  ggplot(gapminder, aes(lifeExp)) + 
    geom_density()
      
  # Density with fill
  ggplot(gapminder, aes(lifeExp, fill = continent)) + 
      geom_density()
  
  # Density with fill and alpha
  ggplot(gapminder, aes(lifeExp, fill = continent)) + 
      geom_density(alpha = .2)
  
  # Density - position stack
  ggplot(gapminder, aes(lifeExp, fill = continent)) + 
      geom_density(position = "stack", alpha = .2)
  
  # Density - position fill
  ggplot(gapminder, aes(lifeExp, fill = continent)) + 
      geom_density(position = "fill", alpha = .2)

```


#### geom_density_ridges

```{r geom-density_ridges, message=FALSE, warning=FALSE, cache=TRUE}
        
  # geom_density_ridges
  ggplot(gapminder, aes(lifeExp, continent, fill = continent)) + 
    ggridges::geom_density_ridges(alpha = .2)
   
  # geom_density_ridges junto con raincloud points y histograma
  ggplot(gapminder, aes(lifeExp, continent, fill = continent)) + 
     ggridges::geom_density_ridges(stat = "binline", bins = 20, scale = 0.95, draw_baseline = FALSE) +
     ggridges::geom_density_ridges(jittered_points = TRUE, position = "raincloud", alpha = 0.7, scale = 0.9)

```




### Facets  

Hay dos funciones para **facet_grid** y **facet_wrap**. facet_grid(~ variable) nos devuelve una matriz simétrica de gráficas. facet_wrap(~ variable) nos devuelve tantas facetas como niveles de la variable.


#### facet_grid

```{r facet_grid, message=FALSE, warning=FALSE, cache=TRUE}
 
  # Plot inicial
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .2) +
    facet_grid(~ continent) +
    guides(alpha = FALSE, color = FALSE)

  # Cambiamos ejes
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .2) +
    facet_grid(continent ~ .) +
    guides(alpha = FALSE, color = FALSE)
  
  # Añadimos una segunda variable
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = country)) +
    geom_line(alpha = .2) +
    facet_grid(continent ~ pop > 5000000) +
    guides(alpha = FALSE, color = FALSE)

```


#### facet_wrap


```{r facet_wrap, message=FALSE, warning=FALSE, cache=TRUE}
 
  # Plot base
  ggplot(gapminder, aes(year, lifeExp, color = continent)) +
    geom_line(alpha = .2) +
    facet_wrap( ~ continent) +
    guides(alpha = FALSE, color = FALSE)

  # Una sola fila
  ggplot(gapminder, aes(year, lifeExp, color = continent)) +
      geom_line(alpha = .2) +
      facet_wrap( ~ continent, nrow = 1) +
      guides(alpha = FALSE, color = FALSE)

  # 5 filas
  ggplot(gapminder, aes(year, lifeExp, color = continent)) +
    geom_line(alpha = .2) +
    facet_wrap(continent ~ gdpPercap > 4000, nrow = 5) +
    guides(alpha = FALSE, color = FALSE)
  
```


### Transformaciones estadísticas  

VER: https://r4ds.had.co.nz/data-visualisation.html#statistical-transformations


#### Proporciones

```{r transformaciones-estadisticas-proporciones, message=FALSE, warning=FALSE, cache=TRUE}

  # Gráfico inicial
  ggplot(gapminder, aes(continent)) +
      geom_bar()
  
  # Proporciones
  ggplot(gapminder, aes(continent, ..prop.., group = 1)) +
    geom_bar()

```


#### stat_summary 

```{r transformaciones-estadisticas-stat_summary, message=FALSE, warning=FALSE, cache=TRUE}

  # Mediana, máximo y mínimo
  ggplot(gapminder, aes(continent, lifeExp)) + 
    stat_summary(
      fun.ymin = min,
      fun.ymax = max,
      fun.y = median)

  # Media y media ± sd
  ggplot(gapminder, aes(continent, lifeExp)) +
    stat_summary(
      fun.ymin = function(x) mean(x) - sd(x),
      fun.ymax = function(x) mean(x) + sd(x),
      fun.y = mean)

```


#### Promedios por grupo

```{r transformaciones-estadisticas-promedios-grupo, message=FALSE, warning=FALSE, cache=TRUE}

# Usando lineas
ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
  geom_point(alpha = .6, size = 4) +
  # geom_line(alpha = .3, size = 1) +
  stat_summary(fun.y = mean,
               geom = "line",
               size = 1,
               alpha = .3)

# Gapminder
ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
  geom_point(alpha = .1) +
  stat_summary(data = gapminder %>% 
                 group_by(continent) %>% 
                 summarise(gdpPercap = mean(gdpPercap),
                           lifeExp  = mean(lifeExp)),
               fun.y = mean,
               geom = "point",
               size = 4)

# Iris
ggplot(iris, aes(Petal.Length, Petal.Width, color = Species)) +
  geom_point(alpha = .4) +
  stat_summary(data = iris %>% 
                 group_by(Species) %>% 
                 summarise(Petal.Length = mean(Petal.Length),
                           Petal.Width  = mean(Petal.Width)),
               fun.y = mean,
               geom = "point",
               size = 4)
    
```


---  

Hagamos una pausa para hacer algunos [ejercicios con transformaciones estadísticas](#ejercicios-transformaciones-estadisticas)  

---  



### Personalización de gráficas


#### Coords  


```{r personalizacion-graficas-coord, message=FALSE, warning=FALSE, cache=TRUE}

  # Gráfico inicial
  ggplot(gapminder, aes(continent)) +
      geom_bar()

  # coord_flip()
  ggplot(gapminder, aes(continent)) +
    geom_bar() +
    coord_flip()

  # coord_polar()
  ggplot(gapminder, aes(continent)) +
    geom_bar() +
    coord_polar()

```



#### Scales  

```{r personalizacion-graficas-axis, message=FALSE, warning=FALSE, cache=TRUE}
  
  # Grafico inicial
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .1) 
  
  # Añadimos breaks en eje y
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .1) +
    scale_y_continuous(breaks = seq(0, 100, 5))
  
  # Separador de miles y breaks en x
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .1) +
    scale_y_continuous(breaks = seq(0, 100, 5)) +
    hrbrthemes::scale_x_comma(breaks = seq(0, 100000, 10000))
  
  # Formato de $ ($M)
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .1) +
    scale_y_continuous(breaks = seq(0, 100, 5)) +
    scale_x_continuous(labels = scales::dollar_format(prefix="$", suffix = "M"),
                       breaks = seq(0, 100000, 20000))
  
  # Escala log
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .1) +
    scale_y_continuous(breaks = seq(0, 100, 5)) +
    scale_x_log10(labels = scales::dollar_format(prefix="$", suffix = "M"))
  
  # Invertimos escala
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .1) +
    scale_y_reverse()

  # No mostramos el texto de los breaks de x
  ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
    geom_point(alpha = .1) +
    scale_y_reverse() +
    theme(axis.text.x = element_blank())
  
  # Proporciones
  ggplot(gapminder, aes(continent, ..prop.., group = 1)) +
    geom_bar()
  
  # %
  ggplot(gapminder, aes(continent, ..prop.., group = 1)) + 
  geom_bar() +
  scale_y_continuous(labels = scales::percent)
  



```


#### Colors and fill scales

```{r personalizacion-graficas-color-fill, message=FALSE, warning=FALSE, cache=TRUE}

  # Plot inicial
  ggplot(gapminder, aes(continent, lifeExp, fill = continent)) + 
    geom_violin(alpha = .2)

  # Relleno usando paleta blues
  ggplot(gapminder, aes(continent, lifeExp, fill = continent)) + 
    geom_violin(alpha = .2) +
    scale_fill_brewer(palette = "Blues")
  
  # Color grey
  ggplot(iris, aes(Petal.Width, Petal.Length, color = Species)) +
    geom_point() + 
    scale_color_grey(start = 0.2, end = 0.8, na.value = "red")
  
  # Gradient
  ggplot(iris, aes(Petal.Width, Petal.Length, color = Petal.Width)) +
    geom_point() + 
    scale_color_gradient(low = "red", high = "blue")
  
  # Gradient con un numero predefinidos de una paleta
  ggplot(iris, aes(Petal.Width, Petal.Length, color = Petal.Width)) +
    geom_point() + 
    scale_colour_gradientn(colours = terrain.colors(3))
  
```


#### Combinando gráficas


```{r personalizando-combinando-basico}

plot1 = ggplot(gapminder, aes(gdpPercap, lifeExp, color = continent)) +
  geom_point(alpha = .1) +
  scale_y_continuous(breaks = seq(0, 100, 5)) +
  scale_x_log10(labels = scales::dollar_format(prefix="$", suffix = "M")) +
  theme(legend.position = "top")

plot2 = ggplot(gapminder, aes(continent, ..prop.., group = 1)) + 
  geom_bar() +
  scale_y_continuous(labels = scales::percent) +
  coord_flip()
  
cowplot::plot_grid(plot2, plot1,
                   rel_widths = c(.3, 0.7))

```


```{r personalizando-combinando-avanzado}

# SOURCE: https://stackoverflow.com/questions/8545035/scatterplot-with-marginal-histograms-in-ggplot2/56440634#56440634

if (!require('cowplot')) install.packages('cowplot'); library('cowplot')

# Set up scatterplot
scatterplot <- ggplot(iris, aes(Sepal.Length, Sepal.Width, color = Species)) +
  geom_point(size = 3, alpha = 0.6) +
  guides(color = FALSE) +
  theme(plot.margin = margin())


# Define marginal histogram
marginal_distribution <- function(x, var, group) {
  ggplot(x, aes_string(x = var, fill = group)) +
    geom_histogram(bins = 30, alpha = 0.4, position = "identity") +
    # geom_density(alpha = 0.4, size = 0.1) +
    guides(fill = FALSE) +
    theme_void() +
    theme(plot.margin = margin())
}

# Set up marginal histograms
x_hist <- marginal_distribution(iris, "Sepal.Length", "Species")
y_hist <- marginal_distribution(iris, "Sepal.Width", "Species") +
  coord_flip()

# Align histograms with scatterplot
aligned_x_hist <- align_plots(x_hist, scatterplot, align = "v")[[1]]
aligned_y_hist <- align_plots(y_hist, scatterplot, align = "h")[[1]]


# Arrange plots
plot_grid(
  aligned_x_hist
  , NULL
  , scatterplot
  , aligned_y_hist
  , ncol = 2
  , nrow = 2
  , rel_heights = c(0.2, 1)
  , rel_widths = c(1, 0.2))

```



#### Usando estilos


https://ggplot2.tidyverse.org/reference/ggtheme.html

https://michaeltoth.me/you-need-to-start-branding-your-graphs-heres-how-with-ggplot.html


```{r personalizacion-graficas-01, message=FALSE, warning=FALSE, cache=TRUE}

if (!require('ggplot2')) install.packages('ggplot2'); library('ggplot2')

# Create a base graph
p <- ggplot(iris, aes(Petal.Width, Petal.Length, color = Species)) +
  geom_point() +
  labs(title = 'A ggplot simple graph',
       subtitle = 'Simple tweaks to improve plots, or not',
       x = '',
       y = '',
       caption = 'https://github.com/gorkang / @gorkang') +
    theme_gray() # This is the default. Needed here because of the Bookdown theme

p

```

Usando el tema fivethirtyeight

```{r personalizacion-graficas-02, message=FALSE, warning=FALSE, cache=TRUE}

# if (!require('hrbrthemes')) install.packages('hrbrthemes'); library('hrbrthemes')
if (!require('ggthemes')) install.packages('ggthemes'); library('ggthemes')

p +
  ggthemes::scale_color_fivethirtyeight() +
  ggthemes::theme_fivethirtyeight()

```

Usando el tema economist
```{r personalizacion-graficas-03, message=FALSE, warning=FALSE, cache=TRUE}

p +
  ggthemes::scale_color_economist() +
  ggthemes::theme_economist()

```


---  

Hagamos una pausa para hacer algunos [ejercicios usando temas, paletas...](#ejercicios-temas)  

---  


## Visualización interactiva


#### Gráficas interactivas

```{r graficas-interactivas, fig.height=8, fig.width=8}
if (!require('plotly')) install.packages('plotly'); library('plotly')

plotly::ggplotly(
  ggplot(gapminder %>% filter(year == 2007), aes(gdpPercap, lifeExp, color = continent, size = country)) +
    geom_point(alpha = .3, point = 2) +
    scale_y_continuous(breaks = seq(0, 100, 5)) +
    scale_x_log10(labels = scales::dollar_format(prefix="$", suffix = "M")) +
  theme(legend.position = "none")
  )

```


#### Animando gráficas

```{r animando-graficas, fig.height=4, fig.width=8}

if (!require('gapminder')) install.packages('gapminder'); library('gapminder')
if (!require('gganimate')) devtools::install_github('thomasp85/gganimate'); library('gganimate')
#sudo apt-get install ffmpeg
  
p = ggplot(gapminder, aes(gdpPercap, lifeExp, size = pop, colour = country)) +
  geom_point(alpha = 0.7, show.legend = FALSE) +
  scale_colour_manual(values = country_colors) +
  scale_size(range = c(2, 12)) +
  scale_x_log10() +
  facet_wrap(~continent) +
  # Here comes the gganimate specific bits
  labs(title = 'Year: {frame_time}', x = 'GDP per capita', y = 'life expectancy') +
  transition_time(year) +
  ease_aes('linear')

animate(p, renderer = ffmpeg_renderer())

```


## Ejercicios  

### Ejercicios con Geoms, colores... {#ejercicios-geoms-colores}

1. Usando el df `mpg`, Crea los 6 plots que se pueden ver más abajo.  

Aquí tienes el plot base, para hacer mas fácil la tarea:   

```{r geoms-ejercicios-0, fig.height=4, fig.width=6}

ggplot(mpg, aes(displ, hwy)) + 
  geom_point() +
  theme_grey()

```


2. Además de generar uno a uno los 6 plots, serías capaz de generar la figura que se ve abajo? Esto es, un plot que incluye los 6 plots juntos.  


```{r geoms-ejercicios, echo=FALSE, fig.height=12, fig.width=12}

plot1 = ggplot(mpg, aes(displ, hwy)) + 
    geom_point() +
    geom_smooth(se = FALSE) +
    theme_grey()

plot2 = ggplot(mpg, aes(displ, hwy, group = drv)) + 
    geom_point() +
    geom_smooth(se = FALSE) +
    theme_grey()

plot3 = ggplot(mpg, aes(displ, hwy, color = drv)) + 
    geom_point() +
    geom_smooth(se = FALSE) +
    theme_grey()

  
plot4 = ggplot(mpg, aes(displ, hwy)) + 
    geom_point(aes(color = drv)) +
    geom_smooth(se = FALSE) +
    theme_grey()

plot5 = ggplot(mpg, aes(displ, hwy, linetype = drv)) + 
    geom_point(aes(color = drv)) +
    geom_smooth(se = FALSE) +
    theme_grey()

  
plot6 = ggplot(mpg, aes(displ, hwy)) + 
    geom_point(color = "white", size = 6) +
    geom_point(aes(color = drv), size = 2) +
    theme_grey()


cowplot::plot_grid(plot1, plot2, plot3, plot4, plot5, plot6,
                   ncol = 2)  
```


3. Con el DF `diamonds`, crea el siguiente plot:  

```{r geoms-ejercicios-02, echo=FALSE}

ggplot(diamonds) + 
  geom_bar(aes(cut, fill = clarity))

```


4. El plot del panel (A) tiene varios problemas (los años no son enteros o factores, los casos no se muestran con un separador de miles, la leyenda esta a la derecha ocupado un espacio precioso, etc.). Trata de resolverlos e intenta llegar al resultado que se ve en el panel (B). Usa el df `table1` del paquete {tidyr}?  


```{r geoms-ejercicios-03, echo=FALSE, fig.height=10, fig.width=8}

plot1 = ggplot(table1, aes(year, cases)) + 
  geom_line(aes(group = country), colour = "grey50") + 
  geom_point(aes(colour = country))

plot2 = ggplot(table1, aes(as.factor(year), cases)) + 
  geom_line(aes(group = country), colour = "grey50") + 
  geom_point(aes(colour = country), size = 2) +
  hrbrthemes::scale_y_comma() +  
  labs(title = "Casos de Tuberculosis por año",
       x = "year",
       caption = "SOURCE: http://www.who.int/tb/country/data/download/en/") +
  theme(legend.position = "bottom", 
        legend.title = element_blank())

cowplot::plot_grid(plot1, plot2, 
                   nrow = 2,
                   labels = c("A", "B"))

```


### Sintaxis aes()


5. Alguna de estas gráficas dará un error? Sin correr el código, sabrías decir cuál de ellas? Hay varias soluciones posibles, ¿Cuales serían?.        

```{r linetype-01, message=FALSE, warning=FALSE, eval = FALSE}

  ggplot(mpg, mapping = aes(displ, hwy, color = class)) +
    geom_point() +
    stat_summary(fun.y = mean, geom = "line", linetype = "dashed")
    
  ggplot(mpg, mapping = aes(displ, hwy, color = class, linetype = class)) +
    geom_point() +
    stat_summary(fun.y = mean, geom = "line")

  ggplot(mpg, mapping = aes(displ, hwy, color = class)) +
    geom_point() +
    stat_summary(fun.y = mean, geom = "line", linetype = class)

```


```{r solucion-linetype-01, eval=FALSE, include=FALSE}

  # SOLUCION 1
  ggplot(mpg, mapping = aes(displ, hwy, color = class)) +
    geom_point() +
    stat_summary(fun.y = mean, geom = "line", aes(linetype = class))

  # SOLUCION 2
  ggplot(mpg, mapping = aes(displ, hwy, color = class, linetype = class)) +
    geom_point() +
    stat_summary(fun.y = mean, geom = "line")
  
  # SOLUCION 3
  ggplot(mpg, mapping = aes(displ, hwy, color = class)) +
    geom_point() +
    stat_summary(fun.y = mean, geom = "line", linetype = "dashed")
  
```


### Temas {#ejercicios-temas}

6a. Serías capaz de reproducir este gráfico, usando el df `diamonds` y el `theme_economist`? 

```{r ejercicio-6a, echo=FALSE}

ggplot(diamonds, aes(price, cut, fill = cut, color = cut)) +
  ggridges::geom_density_ridges(alpha = .6) +
  scale_x_log10() + #labels = scales::dollar_format
  labs(title = "Distribución de precios (log) en función del tipo de corte",
       caption = "@gorkang",
       x = "price (log)") +
  ggthemes::scale_fill_economist() +
  ggthemes::scale_color_economist() +
  ggthemes::theme_economist() +
  theme(legend.position = "none", 
        text = element_text(size = 14))

```

6b. Serías capaz de reproducir este gráfico, usando el df `gapminder` y la paleta `Accent`? 

```{r ejercicio-6b, echo=FALSE}

ggplot(gapminder, aes(gdpPercap, continent, fill = continent, color = continent)) +
  ggridges::geom_density_ridges(alpha = .6) +
  scale_color_brewer(palette = "Accent") +
  scale_fill_brewer(palette = "Accent") +
  theme(legend.position = "none", 
        text = element_text(size = 14),
        axis.title.y = element_blank()) +
  labs(x = "GDP") +
  scale_x_log10(labels = scales::dollar_format(prefix="$", suffix = "M"))


```


### Transformaciones estadísticas {#ejercicios-transformaciones-estadisticas}

7. Cuando al plot **A** trato de añadirle lineas con me aparece algo como lo de **B**.  

```{r ejercicio-7a}
plotA = ggplot(mpg, aes(displ, hwy, color = class)) +
  geom_point() +
  theme(legend.position = "bottom")

plotB = ggplot(mpg, aes(displ, hwy, color = class)) +
  geom_point() +
  geom_line() +
  theme(legend.position = "bottom")

cowplot::plot_grid(plotA, plotB, labels = c("A", "B"))

```

Pero en realidad yo quiero algo como esto. ¿Podrías reproducirlo?  

```{r ejercicio-7b, echo=FALSE}

  ggplot(mpg, aes(displ, hwy, color = class)) +
    geom_point() +
    stat_summary(fun.y = mean, geom = "line") +
    theme(legend.position = "bottom")

```


8. Podrías crear este gráfico? Mostramos mediana ± sd para cada país, organizado por continente.

```{r ejercicio-8, echo=FALSE}

  ggplot(gapminder, aes(country, lifeExp, color = continent)) + 
    stat_summary(
      fun.ymin = function(x) median(x) - sd(x),
      fun.ymax = function(x) median(x) + sd(x),
      fun.y = mean) +
  facet_grid(~ continent) +
  theme(axis.text.x = element_blank())

```


## Bibliografía {.bibliografia -}

+ Matejka, J., & Fitzmaurice, G. (2017, May). Same stats, different graphs: Generating datasets with varied appearance and identical statistics through simulated annealing. In Proceedings of the 2017 CHI Conference on Human Factors in Computing Systems (pp. 1290-1294). ACM.

+ https://bbc.github.io/rcookbook/  

+ https://github.com/bbc/bbplot  

+ https://github.com/dreamRs/esquisse  

+ Garrick Aden-Buie. A Gentle Guide to the Grammar of Graphics with ggplot2: https://github.com/gadenbuie/gentle-ggplot2

+ Michael Toth. You Need to Start Branding Your Graphs. Here's How, with ggplot!: https://michaeltoth.me/you-need-to-start-branding-your-graphs-heres-how-with-ggplot.html  
