
# Control de cambios con Git y Github

---  

#### Paquetes para este capítulo {-}

```{r setup-08, message=FALSE, warning=FALSE}

  if (!require('afex')) install.packages('afex'); library('afex')
  if (!require('correlation')) install.packages("correlation"); library('correlation')
  if (!require('corrr')) install.packages('corrr'); library('corrr')
  if (!require('dplyr')) install.packages('dplyr'); library('dplyr')
  if (!require('DT')) install.packages('DT'); library('DT')
  if (!require('ggraph')) install.packages('ggraph'); library('ggraph')
  if (!require('here')) install.packages('here'); library('here')
  if (!require('gtsummary')) install.packages('gtsummary'); library('gtsummary')
  if (!require('knitr')) install.packages('knitr'); library('knitr')
  if (!require('papaja')) install.packages("papaja"); library('papaja')
  if (!require('parameters')) install.packages('parameters'); library('parameters')
  if (!require('remotes')) install.packages('remotes'); library('remotes')
  if (!require('renv')) install.packages("renv"); library('renv')
  if (!require('report')) install.packages("report"); library('report')
  if (!require('rticles')) install.packages('rticles'); library('rticles')
  if (!require('see')) install.packages("see"); library('see')
  if (!require('sjPlot')) install.packages('sjPlot'); library('sjPlot')
  if (!require('stringi')) install.packages('stringi'); library('stringi')
  if (!require('tinytex')) install.packages('tinytex'); library('tinytex')
  if (!require('usethis')) install.packages('usethis'); library('usethis')
  
```

---  


## Dependencias {.parameters -}

Vamos a necesitar [Git](https://git-scm.com/) y [Latex](https://www.latex-project.org/) para poder trabajar:  

**Instalar Git**  

Ver instrucciones para [Windows](https://happygitwithr.com/install-git.html#install-git-windows), [Mac](https://happygitwithr.com/install-git.html#macos) y [Linux](https://happygitwithr.com/install-git.html#linux).  

|   <span style = "font-size: 10px;">Importante: en el paso *Adjusting your PATH environment* en en Windows, selecciona *Git from the command line and also from 3rd-party software*</span>  




## Git

<div style= "float:right;position: relative; margin:0px 0px 0px 50px;">
![SOURCE: https://xkcd.com/1597/](`r here::here("data/images/git.png")`)    
</div>

Un segundo elemento que nos va a ayudar a trabajar en equipo, y a evitar problemas en proyectos relativamente complejos es el uso de un sistema de control de versiones como [Git](https://git-scm.com/). Los proyectos de RStudio hacen especialmente sencillo usar algunas funcionalidades básicas de Git.   

Algunas referencias útiles:  

* [OhshitGit website](http://ohshitgit.com/?utm_content=buffera425b&utm_medium=social&utm_source=twitter.com&utm_campaign=buffer)  
* [Git in practice](https://github.com/GitInPractice/GitInPractice#readme)  
* [**happygitwithr**](http://happygitwithr.com/)  

<div style="clear: both;"></div>


## Github

<div style= "float:left;position: relative; margin:0px 30px 0px 0px;">
![SOURCE: [github.githubassets.com](https://github.githubassets.com/images/modules/open_graph/github-octocat.png)](`r here::here("data", "images", "github-octocat.png")`)
</div>

[Github](https://github.com) es una plataforma web muy popular donde almacenar proyectos de programación que usa como motor. Muchos de los paquetes de R, el mismo [RStudio](https://github.com/rstudio), etc, tienen repositorios abiertos en Github. Una de las ventajas fundamentales de usar Github es que esta plataforma integra algunas herramientas para hacer más sencillo el control de versiones, como el [pull request](https://help.github.com/en/articles/creating-a-pull-request), que nos permite combinar ramas de proyectos sin apenas problemas.       

Github tiene un programa especial para estudiantes: https://education.github.com/  


  
## Clonar un repositorio existente {#clonar-repo}

Algo que podemos hacer con todos los repositorios de Github es clonarlos localmente:  

#### {.parameters -}

**Primero**, copiamos la `repository URL` del repo de [Github](https://github.com/) (ver imagen de abajo). Será algo similar a `https://github.com/VUESTRO_NOMBRE_DE_USUARIO/NOMBRE_REPOSITORIO.git`  

<div style= "float:left;position: relative; margin:0px 30px 0px 0px;">
![](`r here::here("data", "images", "git-clone.png")`)
</div>  


<div style="clear: both;"></div>


**Segundo**, en RStudio: `File > New Project > Version Control > Git`  

![](`r here::here("data", "images", "rstudio-github.gif")`)




## Crear un proyecto en RStudio asociado a Github  

Podemos empezar creando un repositorio en Github, para después clonarlo localmente. Si necesitamos crear un [personal access token, podemos consultar la ayuda de Github](https://docs.github.com/en/enterprise-server@3.4/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token).  

```
# Puedes usar:  

usethis::create_github_token()

# O manualmente, como los animales:  

  # En tu página de Github, haz click en tu icon (arriba a la derecha) -> Settings -> Developer settings -> Personal access tokens -> [Generate new token] -> Give gist, repo and workflow permissions.
```

### Versión simple [recomendado] {.parameters -}

En [Github](https://github.com/):  

1. Creamos repositorio nuevo  

2. Initialize this repository with a README  

3. [Clonar repositorio](#clonar-repo)  

### {-}


Alternativamente, si ya tenemos un proyecto de RStudio, podemos crear un repositorio de Github asociado automágicamente.  

### Usando el terminal  {.parameters -}

1. Crear local git repo (solo si no lo tenemos aún): `usethis::use_git()` (se crea una carpeta oculta llamada .git)  

2. Crear Github Token: `usethis::create_github_token()`  

3. Insertar token en archivo .Renviron: `usethis::edit_r_environ()`  

4. Crear Github repo: `usethis::use_github()`  

  + Empujar el repositorio local a Github: `git push --set-upstream origin master`  

  
### {-}
  

## Ejercicio Git-Github  {.ejercicio -}

1. Crea un proyecto de RStudio  

2. Abre una cuenta en [Github](https://github.com/) y/o haz login  

3. Sigue los pasos de arriba para crear un repositorio público y asociarlo a un repositorio local  



## Workflow  


<div style= "float:left;position: relative; margin:0px 30px 0px 0px;">
![SOURCE: [nvie.com](https://nvie.com/posts/a-successful-git-branching-model/)](`r here::here("data", "images", "git-basic.png")`)  
</div>

Hay diferentes filosofias sobre cual es la mejor manera de trabajar con Git.

En [este post](https://nvie.com/posts/a-successful-git-branching-model/) por Vincent Driessen podeis ver una explicación bien detallada, complementada con imagenes como la que se ve a continuación.  

El modelo básico implica la existencia de dos ramas. Una master ("producción"), que siempre debe funcionar, y una develop (para desarrollo), donde experimentamos, rompemos cosas, etc.  

Podeis ver un manual super completo llamado [Happy Git and GitHub for the useR](http://happygitwithr.com/) elaborado por Jenny Bryan, Jim Hester, entre otros.  

<div style="clear: both;"></div>


### Modelo básico 

En RStudio podemos trabajar gráficamente, Usando el panel `Git`.  

![](`r here::here("data", "images", "git-rstudio.png")`)  


**Usando el entorno gráfico**  

##### {.parameters -}  

**Empezamos en la rama master**:

0. **Pull** ![](`r here::here("data", "images", "git-pull.png")`) : nos aseguramos que nuestro repositorio local esta actualizado  
1. **Branch** ![](`r here::here("data", "images", "git-branch.png")`) : Creamos nueva rama llamada **development**  
2. Hacemos cambios en nuestros scripts  
3. **Commit** ![](`r here::here("data", "images", "git-commit.png")`) : Commiteamos los cambios  
4. **Push** ![](`r here::here("data", "images", "git-push.png")`) : subimos la rama a Github  
5. **Pull request** (En Github):
- Compare & Pull request  
6. **Pull** ![](`r here::here("data", "images", "git-pull.png")`) : nos aseguramos que nuestro repositorio local esta actualizado  


<details><summary>Como hacerlo usando el `terminal` ![](data/images/hint.png)</summary>
  <span style="color: orange;">

  0. **Pull**: nos aseguramos que nuestro repositorio local esta actualizado: `git pull` 
  1. **Branch**: Creamos nueva rama llamada **development**: `git checkout -b development`  
  2. Hacemos cambios en nuestros scripts  
  3. **Commit**: Commiteamos los cambios  
  - Añadimos archivos: `git add foo.txt`  
  - Hacemos el commit: `git commit --message "A commit message"`  
  4. **Push**: subimos la rama a Github: `git push origin development`  
  5. **Pull request** (En Github):
  - Compare & Pull request
  6. **Pull**: nos aseguramos que nuestro repositorio local esta actualizado: `git pull`   
    
  </span>
</details>   



### Pull request en 3 + 1 sencillos pasos

Después de hacer el push de arriba, al entrar en nuestro repositorio deberíamos ver algo parecido a lo siguiente (si no lo vemos, ir a **branches**). La única dificultad es saber cual de los botones verdes apretar:  

#### Paso 1. Compare & pull request  

<!-- ##### {.parameters -}  -->

![](`r here::here("data", "images", "pull-request-1.png")`){ width=70% }  

<!-- ##### {-}   -->

#### Paso 2. Create pull request  

<!-- ##### {.parameters -}  -->

![](`r here::here("data", "images", "pull-request-2.png")`){ width=70% }  

<!-- ##### {-}  -->

#### Paso 3. Merge pull request  

<!-- ##### {.parameters -}  -->

![](`r here::here("data", "images", "pull-request-3.png")`){ width=70% }  

+  Borrar rama antigua  

<!-- ##### {-}  -->


---  


### Ejercicio {.ejercicio -}

**Nuestro primer commit**  

1. Usando el proyecto de RStudio de antes, crea una rama nueva llamada development  

2. Crea un nuevo archivo en formato .Rmd:  

![](`r here::here("data", "images", "new-Rmd-file.png")`)  

3. Haz un commit de ese archivo y subelo (push) a Github (asegurate que esta allá!). No olvides hacer un pull!  

4. Ahora haz cambios en el archivo, commitealos, súbelos, y sincroniza tu repo local  

### {-}  





<!-- ### Feature branch  -->

<!-- Para la versión más razonable deberiamos tener partir con las siguientes ramas: -->

<!-- * master   -->
<!-- * development   -->


<!-- Queremos implementar un nuevo feature o arreglar algun problema:   -->

<!-- 1. Creamos nueva rama (localmente feature_x)   -->
<!-- `git checkout -b feature_x` -->

<!-- 2. Hacemos cambios   -->
<!-- - Vemos que cambios hay: `git status`, o las diferencias exactas `git diff`     -->
<!-- - Commiteamos los cambios:   -->
<!--   + Añadimos archivos: `git add foo.txt`   -->
<!--   + Hacemos el commit: `git commit --message "A commit message"`   -->


<!-- Ahora viene lo bueno... opción sencilla:   -->

<!-- 3a. Subimos la rama a Github, donde podremos hacer un Pull request:      -->
<!-- - `git push origin feature_x`   -->
<!-- - Si todo ha ido bien, borramos la rama `feature_x`: `git branch -d feature_x`    -->

<!-- La opción menos sencilla: -->

<!-- 3b. Si no esperamos conflictos - mergeamos rama a development para poder probar que todo funciona bien.    -->
<!-- `git checkout development`   -->
<!-- `git pull origin development --ff-only`    -->
<!-- `git merge feature_x`   -->
<!-- `git push origin development`    -->


<!-- ---   -->


<!-- ### Stash   -->


<!-- Hemos hecho algunos cambios pero no queremos hacer commit:   -->

<!-- `git stash`   -->

<!-- Recuperamos los cambios   -->

<!-- `git checkout rama_en_la_que_recuperar_cambios`   -->
<!-- `git stash apply`   -->


<!-- Queremos destruir el stash   -->

<!-- `git stash drop`   -->







## Bibliografía {.bibliografia -}

[Guia de estilo del tidyverse](https://style.tidyverse.org/)  

[Hadley Wickham's Style guide](http://adv-r.had.co.nz/Style.html)  

[Happy Git and GitHub for the useR](https://happygitwithr.com)  

[targets](https://github.com/ropensci/targets)  

Scheel, A. M., Schijen, M., & Lakens, D. (in press). An excess of positive results: Comparing the standard Psychology literature with Registered Reports. Advances in Methods and Practices in Psychological Science.  

Xie, Y., Allaire, J. J., & Grolemund, G. (2018). R Markdown: The Definitive Guide. CRC Press. https://bookdown.org/yihui/rmarkdown/  

Yihui Xie (2018). bookdown: Authoring Books and Technical Documents with R Markdown https://bookdown.org/yihui/bookdown/markdown-syntax.html  

* Mas cosas sobre reproducibilidad:
  + [Reproducibility project: Psychology](https://osf.io/ezcuj/)
  + [Many labs 2](https://osf.io/8cd4r/)
